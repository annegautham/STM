<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teensy Control Panel</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    h2 { margin-top: 20px; }
    button, input[type=range], input[type=number], input[type=text] { margin: 5px; }
    label { margin-right: 10px; }
    #log { background: #f0f0f0; padding: 10px; height: 200px; overflow-y: scroll; border: 1px solid #ccc; white-space: pre-wrap; font-family: monospace; }
  </style>
</head>
<body>
  <h1>Teensy Control Panel</h1>

  <h2>Serial Commands</h2>
  <button onclick="sendCmd('SE')">Enable Serial (SE)</button>
  <button onclick="sendCmd('SD')">Disable Serial (SD)</button>

  <h2>Scan Control</h2>
  <button onclick="sendCmd('EN')">Enable Scanning (EN)</button>
  <button onclick="sendCmd('DL')">Disable Scanning (DL)</button>

  <h2>Tip Control</h2>
  <button onclick="sendCmd('TE')">Engage Tip (TE)</button>
  <button onclick="sendCmd('TR')">Retract Tip (TR)</button>

  <h2>Adjustments</h2>
  <label>Scan Size (SS): <input type="number" id="ss" value="1000"></label>
  <button onclick="sendCmd('SS' + getVal('ss'))">Send</button><br>

  <label>Pixels per Line (IP): <input type="number" id="ip" value="1000"></label>
  <button onclick="sendCmd('IP' + getVal('ip'))">Send</button><br>

  <label>Line Rate (LR x100 Hz): <input type="number" id="lr" value="500"></label>
  <button onclick="sendCmd('LR' + getVal('lr'))">Send</button><br>

  <label>X-Offset (XO): <input type="number" id="xo" value="0"></label>
  <button onclick="sendCmd('XO' + getVal('xo'))">Send</button><br>

  <label>Y-Offset (YO): <input type="number" id="yo" value="0"></label>
  <button onclick="sendCmd('YO' + getVal('yo'))">Send</button><br>

  <label>Setpoint (SP): <input type="number" id="sp" value="1000"></label>
  <button onclick="sendCmd('SP' + getVal('sp'))">Send</button><br>

  <label>Sample Bias (SB): <input type="number" id="sb" value="0"></label>
  <button onclick="sendCmd('SB' + getVal('sb'))">Send</button><br>

  <label>Kp: <input type="number" id="kp" value="100"></label>
  <button onclick="sendCmd('KP' + getVal('kp'))">Send</button><br>

  <label>Ki: <input type="number" id="ki" value="10"></label>
  <button onclick="sendCmd('KI' + getVal('ki'))">Send</button><br>

  <h2>Raw Command</h2>
  <input type="text" id="raw" placeholder="Enter raw command">
  <button onclick="sendCmd(getVal('raw'))">Send</button>

  <h2>Console Log</h2>
  <div id="log"></div>

  <script>
    let ws;
    let logDiv = document.getElementById("log");

    function initWebSocket() {
      ws = new WebSocket(`ws://${location.hostname}:81/`);

      ws.onopen = () => log("[WebSocket] Connected");
      ws.onmessage = (event) => log("[ESP32] " + event.data);
      ws.onclose = () => log("[WebSocket] Disconnected");
      ws.onerror = (e) => log("[WebSocket] Error: " + e);
    }

    function sendCmd(cmd) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(cmd);
        log("[Browser] Sent: " + cmd);
      } else {
        log("[Browser] WebSocket not connected. Cannot send: " + cmd);
      }
    }

    function getVal(id) {
      return document.getElementById(id).value;
    }

    function log(msg) {
      const now = new Date().toLocaleTimeString();
      logDiv.textContent += `[${now}] ${msg}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // Start WebSocket
    initWebSocket();
  </script>
</body>
</html>
